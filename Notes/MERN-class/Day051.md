# MERN CLASS NOTES â€” DAY 050

## ğŸ“† Date: **February 5, 2026 (Thursday)**

---

## ğŸ¯ Topic: CRUD Feature for Earthquake API (Thunder Client + MongoDB)

Today we implemented a full **CRUD API** for our Earthquake project using:

- **Node.js + Express**
- **MongoDB + Mongoose**
- **Thunder Client** (to test API requests)
- **MongoDB Compass** (to confirm database inserts/updates)

---

## ğŸ§  Goal of Today

> Set up API endpoints so that data sent from **Thunder Client** gets stored inside:
- the API (server)
- MongoDB database
- visible in MongoDB Compass

---

## ğŸ§± Basic Flow (How it works)

### 1) Thunder Client sends JSON  
â¬‡ï¸  
### 2) Express receives JSON in `req.body`  
â¬‡ï¸  
### 3) Mongoose model validates + inserts into MongoDB  
â¬‡ï¸  
### 4) MongoDB Compass shows the new document

---

## âš™ï¸ Important Setup Checklist

### âœ… 1. Install packages
```bash
npm init -y
npm install express mongoose cors dotenv
npm install nodemon --save-dev
```

---

### âœ… 2. Add `express.json()` middleware
Without this, `req.body` will be **undefined**.

```js
app.use(express.json());
```

---

### âœ… 3. Start server with nodemon

#### Add to `package.json`
```json
"scripts": {
  "start": "node index.js",
  "dev": "nodemon index.js"
}
```

#### Run:
```bash
npm run dev
```

---

## ğŸ§© Model Setup (Mongoose)

```js
// MODEL 
const Earthquake = mongoose.model("Earthquake", EarthquakeSchema);
```

This model is what allows us to do:

- `Earthquake.create()`
- `Earthquake.find()`
- `Earthquake.findById()`
- `Earthquake.findByIdAndUpdate()`
- `Earthquake.findByIdAndDelete()`

---

## ğŸ›£ï¸ Routes (CRUD)

### ğŸŒ Root route (test server)
```js
app.get("/", (req, res) => {
  res.send("<h1>Earthquake Detection API running...</h1>");
});
```

---

## âœ… CREATE (POST)

### Route:
```js
app.post("/api/earthquakes", async (req, res) => {
  try {
    console.log("Incoming body:", req.body);

    const earthquake = await Earthquake.create(req.body);

    res.status(201).json(earthquake);
  } catch (err) {
    res.status(400).json({
      message: err.message,
      errors: err.errors,
    });
  }
});
```

### Thunder Client setup:
- Method: **POST**
- URL: `http://localhost:8080/api/earthquakes`
- Body â†’ JSON

Example body:
```json
{
  "eventId": "NEP-2026-0011",
  "source": "National Seismological Centre Nepal",
  "detectedAt": "2026-02-04T06:12:30.000Z",
  "location": {
    "type": "Point",
    "coordinates": [85.324, 27.7172]
  },
  "magnitude": {
    "value": 5.3,
    "scale": "Mw"
  },
  "depthKm": 11.6,
  "reviewed": false,
  "remarks": "Light to moderate shaking felt in Kathmandu Valley."
}
```

---

## ğŸ“Œ READ (GET ALL)

```js
app.get("/api/earthquakes", async (req, res) => {
  const earthquakes = await Earthquake.find();
  res.send(earthquakes);
});
```

Thunder Client:
- Method: **GET**
- URL: `http://localhost:8080/api/earthquakes`

---

## ğŸ” READ (GET BY ID)

```js
app.get("/api/earthquakes/:id", async (req, res) => {
  const earthquake = await Earthquake.findById(req.params.id);
  res.send(earthquake);
});
```

Thunder Client:
- Method: **GET**
- URL: `http://localhost:8080/api/earthquakes/<mongodb_id_here>`

---

## â™»ï¸ UPDATE (PUT)

```js
app.put("/api/earthquakes/:id", async (req, res) => {
  const updated = await Earthquake.findByIdAndUpdate(req.params.id, req.body, {
    new: true,
  });
  res.send(updated);
});
```

Thunder Client:
- Method: **PUT**
- URL: `http://localhost:8080/api/earthquakes/<mongodb_id_here>`
- Body â†’ JSON (only the fields you want to change)

Example update body:
```json
{
  "reviewed": true,
  "remarks": "Reviewed and confirmed by NSC."
}
```

---

## ğŸ—‘ï¸ DELETE (DELETE)

```js
app.delete("/api/earthquakes/:id", async (req, res) => {
  const deleted = await Earthquake.findByIdAndDelete(req.params.id);
  res.send(deleted);
});
```

Thunder Client:
- Method: **DELETE**
- URL: `http://localhost:8080/api/earthquakes/<mongodb_id_here>`

---

## ğŸ§ª Testing Notes (Thunder Client)

### âœ”ï¸ Best practice testing order:
1. **POST** â†’ create a new earthquake
2. Copy returned `_id`
3. **GET** all â†’ confirm it exists
4. **GET by id** â†’ confirm one document fetch
5. **PUT** â†’ update fields
6. **DELETE** â†’ remove it

---

## ğŸ§­ MongoDB Compass Check

After POST request succeeds:

1. Open **MongoDB Compass**
2. Go to your database
3. Open the `earthquakes` collection
4. You should see the inserted document instantly

---

## âš ï¸ Common Mistakes

### âŒ `req.body` is empty
Fix:
```js
app.use(express.json());
```

### âŒ POST works but data not visible in Compass
Possible causes:
- Connected to wrong database
- Wrong MongoDB URI
- Using different cluster/local instance

### âŒ Update not working properly
Fix:
```js
{ new: true }
```
Without this, MongoDB returns the **old version**.

---

## ğŸ“ Notes on nodemon

### What is nodemon?
It automatically restarts your server when you save code.

Instead of restarting manually every time.

---

## ğŸ“Œ For Tomorrow

### We will cover:
- Proper **project structure**
- Cleaner folder organization (routes, models, controllers)
- More advanced API handling

---
